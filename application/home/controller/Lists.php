<?phpnamespace app\home\controller; use think\Controller;use think\Url;use think\Config;use think\Page;use think\Verify;use think\Db;use think\Request;use app\home\model\Common; class Lists extends Base {        public function index(){	$cid=input('cid');	$p = input('p/d', 1);    $size = input('size/d', 10);	$label_id= input('label_id/d',0);	$where=array();	$keywords = trim(I('keywords'));    $keywords && $where['title'] = array('like', '%' . $keywords . '%');	$where['is_open']=1;	$cid && $where['cat_id']= $cid;	$label_id && $where['label']=array("like",'%'.$label_id.'%');	$recruit=db('recruit');	$post_category=db('post_category');    $info =$recruit->where($where)->cache(true,60)->page($p,$size)->order("id desc")->select(); //	foreach($info as &$v){		$v['createtime']=date('Y-m-d',$v['publish_time']);		$v['content']=strip_tags($v['content']);		$category=$post_category->where('id',$v['cat_id'])->cache(true,600)->find();		$v['category'] = $category['name'];	}	unset($v);	$count =$recruit->where($where)->count();// 查询满足要求的总记录数    $pager = new Page($count,$size);// 实例化分页类 传入总记录数和每页显示的记录数    $this->assign('pager',$pager);	$this->assign('list',$info);	$this->assign('cid',$cid);     return $this->fetch();    }  	    public function detail(){		$cid=I('cid');		$id=I('id'); 		$info=db('recruit')->where('id',$id)->cache(true,600)->find();		$info['createtime']=date('Y-m-d',$info['publish_time']);		$label=json_decode($info['label'],true);		$type = array('default','danger','default', 'danger', 'success','warning','warning','primary','info');		if($label){		   $str=implode(",",$label);		 $info['labelname'] =  M('label')->where('id','in',$str)->order('id desc')->select();			foreach($info['labelname'] as $k=>$d){				$info['labelname'][$k]['css']=$type[rand(0,8)];			}		}		$data['ip']=request()->ip();		$where['ip']=$data['ip'];		$where['article_id']=$id;		$where['createtime']=strtotime(date('Y-m-d'));		$check=db('looker')->where($where)->order('id desc')->select();		if(empty($check)){			$url='http://ip.taobao.com/service/getIpInfo.php?ip='.$data['ip'];			$getdata=file_get_contents($url);			$ipdata=json_decode($getdata,true);			$data['article_id']=$id;			$data['area']=$ipdata['data']['region'].$ipdata['data']['city'].$ipdata['data']['isp'];			$data['createtime']=time();			if($data['ip'] && $data['area']){				$save['count']=$info['count']+1;				db('recruit')->where('id',$id)->update($save);				db('looker')->insert($data);			};		}		$this->assign('cid',$cid);		$this->assign('info',$info);		 return $this->fetch();    }}